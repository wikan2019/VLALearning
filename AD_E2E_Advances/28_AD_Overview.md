# 28. 从模块化到端到端：自动驾驶架构范式变革

> 自动驾驶正经历一场与 NLP 领域类似的范式变革：从精心设计的模块化流水线走向数据驱动的端到端神经网络。

[⬅️ 返回 AD 目录](./README.md) | [➡️ 下一篇: BEV 感知](./29_BEV_Perception.md)

---

## 1. 传统模块化架构

### 1.1 流水线概览

传统自动驾驶系统由多个独立模块串联而成，每个模块各司其职：

```
┌─────────────────────────────────────────────────────────────────────┐
│                    传统模块化自动驾驶架构                              │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌──────────┐   ┌──────────────┐   ┌──────────┐   ┌──────────┐    │
│  │ 传感器    │   │  感知模块     │   │ 预测模块  │   │ 规划模块  │    │
│  │ Sensors  │──▶│ Perception   │──▶│Prediction│──▶│ Planning │    │
│  └──────────┘   └──────────────┘   └──────────┘   └────┬─────┘    │
│   Camera×6       - 3D 检测         - 轨迹预测          │           │
│   LiDAR×1        - 语义分割        - 意图识别          ▼           │
│   Radar×5        - 车道线检测      - 交互建模    ┌──────────┐     │
│   IMU/GPS        - 目标跟踪                     │ 控制模块  │     │
│                                                 │ Control  │     │
│                                                 └──────────┘     │
│                                                  方向盘/油门/刹车  │
└─────────────────────────────────────────────────────────────────────┘
```

### 1.2 数据流细节

```
Camera ──┐                 ┌── 3D BBox ──┐              ┌── Agent 未来轨迹 ──┐
         ├── Feature ──▶  │  语义地图   ├── Track ──▶ │  车道意图          ├──▶ 规划轨迹 ──▶ PID/MPC
LiDAR ───┘   Extraction    └── 车道线   ──┘   List      └── 交互概率        ──┘               控制器
                                ↑
                           HD Map (先验)
```

### 1.3 模块化的优势

| 优势 | 说明 |
|------|------|
| **职责清晰** | 每个模块目标明确，团队可并行开发 |
| **独立调试** | 感知错了查感知，规划错了查规划 |
| **独立验证** | 每个模块有自己的 benchmark（如 nuScenes detection） |
| **工程成熟** | 20+ 年工业积累，大量可复用的算法和工具链 |
| **可解释性** | 中间结果（检测框、轨迹预测）直观可视化 |

---

## 2. 模块化架构的核心问题

### 2.1 信息瓶颈（Information Bottleneck）

每个模块只向下游传递**压缩后的结构化输出**（如 3D 检测框），丢弃了丰富的原始特征：

```
原始信息量:     ████████████████████████  (100%)
                        ↓ 感知输出 (3D BBox + Score)
传递信息量:     ████                      (~15%)
                        ↓ 预测输出 (轨迹点)
传递信息量:     ██                        (~8%)
                        ↓ 规划输入
可用信息量:     █                         (~5%)
```

**关键损失**：
- 检测框丢弃了物体的**精细形状和姿态**信息
- 离散的跟踪 ID 丢弃了**不确定性分布**
- 确定性的预测轨迹丢弃了**多模态可能性**

### 2.2 误差累积（Error Accumulation）

上游的微小误差在传播过程中会被逐级放大：

```
场景: 一辆大卡车在路边停着，检测稍有偏差

真实位置:        [====卡车====]
                              |  道路边界
                              |

检测结果 (偏移0.3m):   [====卡车====]    ← 感知误差: 0.3m
                              |
跟踪关联:              [====卡车====]    ← 跟踪继承误差
                              |
预测: "卡车将进入车道"  [====卡车====]→→  ← 预测误判: 静止→移动
                              |
规划: 急刹车/急变道     自车紧急制动!     ← 规划过度反应

结果: 一个 0.3m 的检测偏差 → 一次不必要的急刹车（phantom braking）
```

### 2.3 不可导的接口（Non-differentiable Interface）

```python
# 模块化架构: 梯度在模块边界被截断
perception_output = perception_model(sensor_data)   # 可导
tracking_output   = hungarian_matching(perception_output)  # ✗ 不可导!
prediction_output = prediction_model(tracking_output)      # 可导
planning_output   = rule_based_planner(prediction_output)  # ✗ 不可导!

# 问题: 规划的 loss 无法回传到感知模型
# ∂L_planning / ∂θ_perception = 0  (梯度断流)
```

**后果**：感知模型的优化目标（检测精度）与最终目标（安全驾驶）不一致。一个 mAP 99% 的检测器，可能在关键场景上犯致命错误。

---

## 3. 端到端架构的核心思想

### 3.1 基本理念

**端到端（End-to-End）**：让梯度从最终的驾驶目标一路回传到原始传感器输入。

```
┌─────────────────────────────────────────────────────────┐
│                端到端自动驾驶架构                          │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Camera ──┐      ┌─────────────────────┐    轨迹/控制   │
│           ├──▶  │    统一神经网络       │──▶  输出       │
│  LiDAR ───┘      │  (Unified Network)  │               │
│                   └─────────────────────┘               │
│                          ▲                              │
│                  Loss: L2(轨迹) + 碰撞 + 舒适度          │
│                          │                              │
│           ∂L/∂θ 从 loss 一路回传到图像编码器               │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 3.2 端到端的三个层次

端到端并非"一步到位"，业界实践中存在**三个层次的渐进演进**：

```
Level 1: 特征级 E2E (Feature-level)
┌─────────────┐     ┌──────┐  ┌──────┐  ┌──────┐
│ 共享主干     │──▶ │ 检测  │  │ 预测  │  │ 规划  │
│ Shared      │──▶ │ Head │──▶│ Head │──▶│ Head │──▶ 轨迹
│ Backbone    │──▶ │      │  │      │  │      │
└─────────────┘     └──────┘  └──────┘  └──────┘
代表: UniAD (CVPR 2023 Best Paper)
特点: 模块仍在, 但共享特征, 联合训练

──────────────────────────────────────────

Level 2: 轨迹级 E2E (Trajectory-level)
┌─────────────┐     ┌─────────────────────┐
│ 编码器       │──▶ │ 直接输出轨迹         │──▶ 轨迹
│ Encoder     │     │ (无显式中间任务)      │
└─────────────┘     └─────────────────────┘
代表: VAD, GenAD, DriveTransformer
特点: 去掉显式感知输出, 直接从特征到轨迹

──────────────────────────────────────────

Level 3: 控制级 E2E (Control-level)
┌─────────────┐     ┌─────────────────────┐
│ 编码器       │──▶ │ 直接输出控制信号      │──▶ 方向盘角度
│ Encoder     │     │                     │    油门/刹车
└─────────────┘     └─────────────────────┘
代表: Tesla FSD v12+, NVIDIA DAVE-2
特点: 最纯粹的端到端, 输出 steering/throttle/brake
```

### 3.3 梯度流对比

```
模块化:  Sensor → [Perception] ✗ [Tracking] ✗ [Prediction] ✗ [Planning]
                               ↑ 梯度断流    ↑ 梯度断流      ↑ 梯度断流

E2E:     Sensor → [═══════════ Unified Network ════════════] → Output
                  ←←←←←←←← 梯度连续回传 ←←←←←←←←←←←←←←←←   Loss
```

---

## 4. 开环 vs 闭环评估

### 4.1 两种评估范式

| 维度 | 开环（Open-loop） | 闭环（Closed-loop） |
|------|-------------------|---------------------|
| **方式** | 回放数据集，比较预测轨迹与真值 | 模型控制车辆在仿真中行驶 |
| **指标** | L2 距离、碰撞率、FDE | 驾驶分数、路线完成率、违规次数 |
| **交互** | 无（其他车辆按原始轨迹走） | 有（其他车辆对 ego 行为做出反应） |
| **成本** | 低（只需前向推理） | 高（需要仿真器，运行慢） |
| **真实性** | 低 | 高 |

### 4.2 开环指标的陷阱

```
场景: 前方红灯，真值是刹车停在停止线

开环评估:
  模型输出: 缓慢减速停车 (L2 = 0.5m) ← 看起来不错!
  但模型可能只是在 "抄答案"——记住了数据分布

闭环评估:
  绿灯变红灯 → 模型犹豫 → 闯红灯 → 碰撞!
  因为训练数据中这个时间点都是绿灯，模型没见过这种情况

结论: 开环 L2 低 ≠ 真实驾驶好
      (Open-loop L2 ↓ ≠ Closed-loop Score ↑)
```

### 4.3 主要闭环评估平台

| 平台 | 特点 | 典型指标 |
|------|------|---------|
| **CARLA** | 开源仿真器，丰富场景 | Driving Score, Route Completion |
| **nuPlan** | Motional 推出，真实场景回放 | OLS (Open-loop Score), CLS (Closed-loop Score) |
| **NAVSIM** | 非反应式闭环，平衡效率与真实性 | PDMS (Planning-aware Driving Model Score) |
| **Waymax** | Waymo 推出，大规模并行仿真 | Overlap Rate, Off-road Rate |

---

## 5. 端到端自动驾驶的里程碑时间线

```
2015 ──── NVIDIA DAVE-2
           首个 CNN 端到端驾驶 (camera → steering)
           │
2020 ──── BEV 感知革命开始
           LSS (Lift-Splat-Shoot) 提出相机到 BEV 的投影方法
           │
2022 ──── BEVFormer / BEVDet
           Transformer 驱动的 BEV 感知, 成为行业标配
           │
2023 ──── UniAD (CVPR Best Paper)          ★ 里程碑
           首个规划导向的统一框架, 证明联合训练全面优于独立训练
           ├── VAD
           │   向量化场景表示, 去掉 HD Map 依赖
           │
2024 ──── EMMA (Waymo)
           VLM 驱动的多任务驾驶模型 (Gemini backbone)
           ├── GenAD
           │   生成式端到端: 用 VAE 对轨迹分布建模
           ├── Tesla FSD v12                ★ 里程碑
           │   首个大规模部署的控制级 E2E (替换 30 万行 C++)
           │
2025 ──── DriveTransformer
           解耦 Transformer 架构, 闭环 SOTA
           ├── UniUGP
           │   统一生成: 一个 GPT 同时生成感知 + 预测 + 规划
           ├── AD-R1
           │   强化学习 + 推理 (类 DeepSeek-R1) 用于驾驶决策
           ├── Tesla FSD v13               ★ 里程碑
           │   6x 安全提升, "高速公路到停车场" 全场景覆盖
           │
2026 ──── Tesla FSD Reasoning AI
           引入链式推理 (Chain-of-Thought) 到驾驶决策
           ├── Waymo Foundation Model
               统一的基础模型处理感知 + 预测 + 规划
```

---

## 6. 端到端 vs 模块化：全面对比表

| 维度 | 模块化架构 | 端到端架构 |
|------|-----------|-----------|
| **感知精度** | 单模块 SOTA（mAP 高） | 整体优化，感知为规划服务 |
| **规划质量** | 受限于接口信息损失 | 直接优化驾驶目标，通常更优 |
| **安全性** | 可加规则兜底（safety layer） | 依赖数据覆盖 + 后处理安全层 |
| **可解释性** | ✅ 高：中间结果可视化 | ❌ 低：黑箱，需额外可解释模块 |
| **开发成本** | 高：每个模块需专家团队 | 低：统一模型 + 数据驱动 |
| **数据需求** | 每个模块需标注（3D 框、地图等） | 只需轨迹标注，但需海量数据 |
| **调试难度** | 低：逐模块排查 | 高：需要归因分析工具 |
| **部署成熟度** | ✅ 高：Waymo L4 已商用 | 🔄 中：Tesla FSD 大规模验证中 |
| **迭代速度** | 慢：改一个模块可能影响全局 | 快：端到端 retrain 一次即可 |
| **天花板** | 受限于接口设计 | 理论上限更高（数据 + 算力驱动） |

### 行业趋势

```
2020:  100% 模块化          ████████████████████
2023:  模块化 + E2E 探索    ████████████████  ████
2025:  混合架构为主          ██████████  ██████████
2026:  E2E 逐步主导          ████  ████████████████
2030:  E2E + 安全层 (预期)    ██  ██████████████████
       (模块化)              (端到端)
```

> **核心结论**：端到端不是"替代"模块化，而是**吸收**模块化的设计智慧（如多任务辅助训练、安全兜底层），同时用数据驱动的方式消除信息瓶颈。当前最强系统（Tesla FSD v13, Waymo）都采用 **"端到端主体 + 安全规则兜底"** 的混合策略。

---

## 关联阅读

- [29. BEV 感知](./29_BEV_Perception.md)——端到端的感知基石
- [30. UniAD](./30_UniAD.md)——Feature-level E2E 的代表
- [32. 端到端规划](./32_E2E_Planning.md)——Trajectory-level E2E 的深入解析
- [35. Tesla FSD](./35_Tesla_FSD.md)——Control-level E2E 的工业实践
- [VLA/17. VLA 概述](../VLA_Advances/17_VLA_Overview.md)——同源的具身智能范式

---

[⬅️ 返回 AD 目录](./README.md)
